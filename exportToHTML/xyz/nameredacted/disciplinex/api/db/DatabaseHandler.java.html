<html>
<head>
<title>DatabaseHandler.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #3d8beb; font-style: italic;}
.s1 { color: #ececee;}
.s2 { color: #ffffff; font-style: italic;}
.s3 { color: #40bf77;}
.s4 { color: #6f7a86; font-style: italic;}
.s5 { color: #ffffff;}
.s6 { color: #f9846c;}
.s7 { color: #40bf77; font-style: italic;}
.s8 { color: #6f7a86; font-weight: bold; font-style: italic;}
</style>
</head>
<body bgcolor="#202831">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DatabaseHandler.java</font>
</center></td></tr></table>
<pre><span class="s0">package </span><span class="s1">xyz</span><span class="s2">.</span><span class="s1">nameredacted</span><span class="s2">.</span><span class="s1">disciplinex</span><span class="s2">.</span><span class="s1">api</span><span class="s2">.</span><span class="s1">db</span><span class="s3">;</span>


<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">bukkit</span><span class="s2">.</span><span class="s1">Bukkit</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">bukkit</span><span class="s2">.</span><span class="s1">entity</span><span class="s2">.</span><span class="s1">Player</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">jetbrains</span><span class="s2">.</span><span class="s1">annotations</span><span class="s2">.</span><span class="s1">NotNull</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">jetbrains</span><span class="s2">.</span><span class="s1">annotations</span><span class="s2">.</span><span class="s1">TestOnly</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">xyz</span><span class="s2">.</span><span class="s1">nameredacted</span><span class="s2">.</span><span class="s1">disciplinex</span><span class="s2">.</span><span class="s1">DisciplineX</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">xyz</span><span class="s2">.</span><span class="s1">nameredacted</span><span class="s2">.</span><span class="s1">disciplinex</span><span class="s2">.</span><span class="s1">api</span><span class="s2">.</span><span class="s1">Punishment</span><span class="s3">;</span>

<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">sql</span><span class="s2">.</span><span class="s3">*;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">ArrayList</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">UUID</span><span class="s3">;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">concurrent</span><span class="s2">.</span><span class="s1">CompletableFuture</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* This class is used to handle the database</span>
 <span class="s4">* connection and to perform queries on the database.</span>
 <span class="s4">*/</span>
<span class="s0">public class </span><span class="s1">DatabaseHandler </span><span class="s5">{</span>

    <span class="s4">/* 
     * TODO: In Sprint 2, make database 
     * credentials available to change in config.yml 
     */</span>

    <span class="s0">private static final </span><span class="s1">String host </span><span class="s3">= &quot;localhost&quot;;</span>
    <span class="s0">private static final int </span><span class="s1">port </span><span class="s3">= </span><span class="s6">3306</span><span class="s3">;</span>
    <span class="s0">private static final </span><span class="s1">String databaseName </span><span class="s3">= &quot;disciplinex&quot;;</span>
    <span class="s0">private static final </span><span class="s1">String username </span><span class="s3">= &quot;disciplinex&quot;;</span>
    <span class="s0">private static final </span><span class="s1">String password </span><span class="s3">= &quot;example&quot;;</span>

    <span class="s0">public static </span><span class="s1">Connection createConnection</span><span class="s5">() {</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s1">Class</span><span class="s2">.</span><span class="s1">forName</span><span class="s5">(</span><span class="s3">&quot;com.mysql.cj.jdbc.Driver&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s0">return </span><span class="s1">DriverManager</span><span class="s2">.</span><span class="s1">getConnection</span><span class="s5">(</span><span class="s3">&quot;jdbc:mysql://&quot; + </span><span class="s1">host </span><span class="s3">+ &quot;:&quot; + </span><span class="s1">port </span><span class="s3">+ &quot;/&quot; + </span><span class="s1">databaseName</span><span class="s5">, </span><span class="s1">username</span><span class="s5">, </span><span class="s1">password</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;The plugin has made an error to connect to the MySQL Database and has been shut down.&quot; +</span>
                    <span class="s3">&quot;</span><span class="s1">\n</span><span class="s3">Please check your configuration. This is most likely due to incorrect credentials.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">printStackTrace</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">ClassNotFoundException e</span><span class="s5">) {</span>
            <span class="s0">throw new </span><span class="s1">RuntimeException</span><span class="s5">(</span><span class="s1">e</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s5">}</span>
        <span class="s0">return null</span><span class="s3">;</span>
    <span class="s5">}</span>


    <span class="s0">public void </span><span class="s1">setupDatabase</span><span class="s5">() {</span>
        <span class="s1">createPlayersTable</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">createActivePunishmentTable</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s1">createPunishmentHistoryTable</span><span class="s5">()</span><span class="s3">;</span>
    <span class="s5">}</span>

    <span class="s4">/**</span>
     <span class="s4">* This function creates the players</span>
     <span class="s4">* table for the database. Database Schema:</span>
     <span class="s4">* </span><span class="s7">&lt;pre&gt;</span>
     <span class="s4">*     {</span><span class="s8">@code</span>
     <span class="s4">*     player_id INT	PRIMARY KEY, AUTO_INCREMENT</span>
     <span class="s4">*     uuid	VARCHAR(36)	UNIQUE, NOT NULL</span>
     <span class="s4">*     name	VARCHAR(16)	NOT NULL</span>
     <span class="s4">*     }</span>
     <span class="s4">* </span><span class="s7">&lt;/pre&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* This function is run synchronously as it is run once when the plugin is enabled.</span>
     <span class="s4">*/</span>
    <span class="s1">@TestOnly</span>
    <span class="s0">private void </span><span class="s1">createPlayersTable</span><span class="s5">() {</span>
        <span class="s1">Connection conn </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s0">final </span><span class="s1">PreparedStatement createTable </span><span class="s3">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;CREATE TABLE IF NOT EXISTS players (&quot; +</span>
                    <span class="s3">&quot;player_id INT PRIMARY KEY AUTO_INCREMENT,&quot; +</span>
                    <span class="s3">&quot;uuid VARCHAR(36) UNIQUE NOT NULL,&quot; +</span>
                    <span class="s3">&quot;name VARCHAR(16) NOT NULL);&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">createTable</span><span class="s2">.</span><span class="s1">execute</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while creating the players table. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s4">/**</span>
     <span class="s4">* This function creates the players</span>
     <span class="s4">* table for the database. Database Schema:</span>
     <span class="s4">* </span><span class="s7">&lt;pre&gt;</span>
     <span class="s4">*     {</span><span class="s8">@code</span>
     <span class="s4">*     punishment_id	INT	PRIMARY KEY, AUTO_INCREMENT</span>
     <span class="s4">*     player_id	INT	FOREIGN KEY REFERENCES players(player_id)</span>
     <span class="s4">*     punisher_id	INT	FOREIGN KEY REFERENCES players(player_id)</span>
     <span class="s4">*     type	ENUM	('BAN', 'MUTE', 'KICK', 'WARN'), NOT NULL</span>
     <span class="s4">*     reason	TEXT</span>
     <span class="s4">*     start_date	DATETIME	NOT NULL</span>
     <span class="s4">*     expiry_date	DATETIME</span>
     <span class="s4">*     expiry_date_actual	DATETIME</span>
     <span class="s4">*     }</span>
     <span class="s4">* </span><span class="s7">&lt;/pre&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* This function is run synchronously as it is run once when the plugin is enabled.</span>
     <span class="s4">*/</span>
    <span class="s1">@TestOnly</span>
    <span class="s0">private void </span><span class="s1">createActivePunishmentTable</span><span class="s5">() {</span>
        <span class="s1">Connection conn </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s0">final </span><span class="s1">PreparedStatement createTable </span><span class="s3">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;CREATE TABLE IF NOT EXISTS active_punishments (&quot; +</span>
                    <span class="s3">&quot;punishment_id INT PRIMARY KEY AUTO_INCREMENT,&quot; +</span>
                    <span class="s3">&quot;player_id VARCHAR(36), &quot; +</span>
                    <span class="s3">&quot;FOREIGN KEY (player_id) REFERENCES players(player_id),&quot; +</span>
                    <span class="s3">&quot;punisher_id VARCHAR(36), &quot; +</span>
                    <span class="s3">&quot;FOREIGN KEY (punisher_id) REFERENCES players(player_id),&quot; +</span>
                    <span class="s3">&quot;punishment_type ENUM('BAN', 'MUTE', 'KICK', 'WARN') NOT NULL,&quot; +</span>
                    <span class="s3">&quot;reason TEXT,&quot; +</span>
                    <span class="s3">&quot;start_date DATETIME NOT NULL,&quot; +</span>
                    <span class="s3">&quot;expiry_date DATETIME,&quot; +</span>
                    <span class="s3">&quot;expiry_date_actual DATETIME);&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s4">/**</span>
             <span class="s4">* Old query: Issue (11-09-2024)</span>
             <span class="s4">* &quot;CREATE TABLE IF NOT EXISTS active_punishments (&quot; +</span>
             <span class="s4">*                     &quot;punishment_id INT PRIMARY KEY AUTO_INCREMENT,&quot; +</span>
             <span class="s4">*                     &quot;player_id INT FOREIGN KEY (player_id) REFERENCES players(player_id),&quot; +</span>
             <span class="s4">*                     &quot;punisher_id INT FOREIGN KEY (punisher_id) REFERENCES players(player_id),&quot; +</span>
             <span class="s4">*                     &quot;punishment_type ENUM('BAN', 'MUTE', 'KICK', 'WARN') NOT NULL,&quot; +</span>
             <span class="s4">*                     &quot;reason TEXT,&quot; +</span>
             <span class="s4">*                     &quot;start_date DATETIME NOT NULL,&quot; +</span>
             <span class="s4">*                     &quot;expiry_date DATETIME,&quot; +</span>
             <span class="s4">*                     &quot;expiry_date_actual DATETIME);&quot;);</span>
             <span class="s4">*/</span>
            <span class="s1">createTable</span><span class="s2">.</span><span class="s1">execute</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while executing a database query. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">printStackTrace</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s4">/**</span>
     <span class="s4">* This function creates the players</span>
     <span class="s4">* table for the database. Database Schema:</span>
     <span class="s4">* </span><span class="s7">&lt;pre&gt;</span>
     <span class="s4">*     {</span><span class="s8">@code</span>
     <span class="s4">*     id	INT	PRIMARY KEY, AUTO_INCREMENT</span>
     <span class="s4">*     punishment_id	INT	FOREIGN KEY REFERENCES punishments(punishment_id)</span>
     <span class="s4">*     action	ENUM	('CREATED', 'EXPIRED', 'LIFTED'), NOT NULL</span>
     <span class="s4">*     timestamp	DATETIME	NOT NULL</span>
     <span class="s4">*     }</span>
     <span class="s4">* </span><span class="s7">&lt;/pre&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* This function is run synchronously as it is run once when the plugin is enabled.</span>
     <span class="s4">*/</span>
    <span class="s1">@TestOnly</span>
    <span class="s0">private void </span><span class="s1">createPunishmentHistoryTable</span><span class="s5">() {</span>
        <span class="s1">Connection conn </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s0">final </span><span class="s1">PreparedStatement createTable </span><span class="s3">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;CREATE TABLE IF NOT EXISTS punishment_history (&quot; +</span>
                    <span class="s3">&quot;id INT PRIMARY KEY AUTO_INCREMENT,&quot; +</span>
                    <span class="s3">&quot;punishment_id INT, &quot; +</span>
                    <span class="s3">&quot;FOREIGN KEY (punishment_id) REFERENCES active_punishments(punishment_id),&quot; +</span>
                    <span class="s3">&quot;action ENUM('CREATED', 'EXPIRED', 'LIFTED') NOT NULL,&quot; +</span>
                    <span class="s3">&quot;timestamp DATETIME NOT NULL);&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">createTable</span><span class="s2">.</span><span class="s1">execute</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s4">/**</span>
             <span class="s4">* Old query:</span>
             <span class="s4">* &quot;CREATE TABLE IF NOT EXISTS punishment_history (&quot; +</span>
             <span class="s4">*                     &quot;id INT PRIMARY KEY AUTO_INCREMENT,&quot; +</span>
             <span class="s4">*                     &quot;punishment_id INT FOREIGN KEY (punishment_id) REFERENCES active_punishments(punishment_id),&quot; +</span>
             <span class="s4">*                     &quot;action ENUM('CREATED', 'EXPIRED', 'LIFTED') NOT NULL,&quot; +</span>
             <span class="s4">*                     &quot;timestamp DATETIME NOT NULL);&quot;);</span>
             <span class="s4">*/</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while creating the players table. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">printStackTrace</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s4">// Asynchronous ver. (checkmute)</span>
    <span class="s1">@TestOnly</span>
    <span class="s0">public </span><span class="s1">CompletableFuture</span><span class="s3">&lt;</span><span class="s1">ResultSet</span><span class="s3">&gt; </span><span class="s1">asyncIsPlayerMuted</span><span class="s5">(</span><span class="s0">final </span><span class="s1">@NotNull UUID uuid</span><span class="s5">) {</span>
        <span class="s0">return </span><span class="s1">CompletableFuture</span><span class="s2">.</span><span class="s1">supplyAsync</span><span class="s5">(() </span><span class="s1">-&gt; </span><span class="s5">{</span>
            <span class="s1">Connection conn </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s0">try </span><span class="s5">{</span>
                <span class="s1">PreparedStatement ps </span><span class="s3">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;&quot;</span><span class="s5">)</span><span class="s3">;</span>
                <span class="s0">return </span><span class="s1">ps</span><span class="s2">.</span><span class="s1">executeQuery</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
                <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while querying the database. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
                <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
                <span class="s0">return null</span><span class="s3">;</span>
            <span class="s5">}</span>
        <span class="s5">})</span><span class="s3">;</span>
    <span class="s5">}</span>

    <span class="s4">// Synchronous ver. (checkmute)</span>
    <span class="s0">public boolean </span><span class="s1">isPlayerMuted</span><span class="s5">(</span><span class="s0">final </span><span class="s1">@NotNull UUID uuid</span><span class="s5">) {</span>
        <span class="s0">boolean </span><span class="s1">muted </span><span class="s3">= </span><span class="s0">false</span><span class="s3">;</span>
        <span class="s1">Connection dbConnection </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s0">final </span><span class="s1">PreparedStatement checkPlayerQuery </span><span class="s3">= </span><span class="s1">dbConnection</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;SELECT * &quot;</span><span class="s5">)</span><span class="s3">;</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while querying the database. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">}</span>

        <span class="s0">return </span><span class="s1">muted</span><span class="s3">;</span>
    <span class="s5">}</span>

    <span class="s4">// Insert punishment into database (synchronous) (permanent)</span>

    <span class="s4">/**</span>
     <span class="s4">* This method is used to insert a punishment into the database.</span>
     <span class="s4">* This method is synchronous. In the future (iteration 3) it will</span>
     <span class="s4">* be converted to be an asynchronous implementation.</span>
     <span class="s4">* </span><span class="s8">@param </span><span class="s4">punishment punishment object to insert into database</span>
     <span class="s4">*/</span>
    <span class="s0">public void </span><span class="s1">insertPunishment</span><span class="s5">(</span><span class="s0">final </span><span class="s1">@NotNull Punishment punishment</span><span class="s5">) {</span>
        <span class="s1">Connection conn </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s0">final </span><span class="s1">PreparedStatement insertPunishment </span><span class="s3">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;INSERT INTO active_punishments (player_id, punisher_id, punishment_type, reason, start_date, expiry_date, expiry_date_actual) VALUES (?, ?, ?, ?, ?, ?, ?);&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">setString</span><span class="s5">(</span><span class="s6">1</span><span class="s5">, </span><span class="s1">punishment</span><span class="s2">.</span><span class="s1">getPlayerPunished</span><span class="s5">())</span><span class="s3">;</span>
            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">setString</span><span class="s5">(</span><span class="s6">2</span><span class="s5">, </span><span class="s1">punishment</span><span class="s2">.</span><span class="s1">getBlame</span><span class="s5">())</span><span class="s3">;</span>
            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">setString</span><span class="s5">(</span><span class="s6">3</span><span class="s5">, </span><span class="s1">punishment</span><span class="s2">.</span><span class="s1">getPunishmentType</span><span class="s5">()</span><span class="s2">.</span><span class="s1">toString</span><span class="s5">())</span><span class="s3">;</span>
            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">setString</span><span class="s5">(</span><span class="s6">4</span><span class="s5">, </span><span class="s1">punishment</span><span class="s2">.</span><span class="s1">getReason</span><span class="s5">())</span><span class="s3">;</span>
            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">setTimestamp</span><span class="s5">(</span><span class="s6">5</span><span class="s5">, </span><span class="s0">new </span><span class="s1">Timestamp</span><span class="s5">(</span><span class="s1">punishment</span><span class="s2">.</span><span class="s1">getOrigin</span><span class="s5">()</span><span class="s2">.</span><span class="s1">getTime</span><span class="s5">()))</span><span class="s3">;</span>
            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">setTimestamp</span><span class="s5">(</span><span class="s6">6</span><span class="s5">, </span><span class="s0">new </span><span class="s1">Timestamp</span><span class="s5">(</span><span class="s1">punishment</span><span class="s2">.</span><span class="s1">getExpiry</span><span class="s5">()</span><span class="s2">.</span><span class="s1">getTime</span><span class="s5">()))</span><span class="s3">;</span>

            <span class="s1">insertPunishment</span><span class="s2">.</span><span class="s1">execute</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s4">//            insertPunishment.setInt(1, punishment.getPlayerId());</span>
<span class="s4">//            insertPunishment.setInt(2, punishment.getPunisherId());</span>
<span class="s4">//            insertPunishment.setString(3, punishment.getPunishmentType().toString());</span>
<span class="s4">//            insertPunishment.setString(4, punishment.getReason());</span>
<span class="s4">//            insertPunishment.setTimestamp(5, new Timestamp(punishment.getStartDate().getTime()));</span>
<span class="s4">//            insertPunishment.setTimestamp(6, new Timestamp(punishment.getExpiryDate().getTime()));</span>
<span class="s4">//            insertPunishment.setTimestamp(7, new Timestamp(punishment.getExpiryDateActual().getTime()));</span>
<span class="s4">//            insertPunishment.execute();</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while inserting a punishment into the database. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s4">/**</span>
     <span class="s4">* This method will retrieve every user which is currently muted.</span>
     <span class="s4">* </span><span class="s8">@return </span><span class="s4">ResultSet containing every user which is currently muted.</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s1">ArrayList</span><span class="s3">&lt;</span><span class="s1">Player</span><span class="s3">&gt; </span><span class="s1">getOnlineMutedPlayers</span><span class="s5">() {</span>
        <span class="s1">Connection conn </span><span class="s3">= </span><span class="s1">createConnection</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">assert </span><span class="s1">conn </span><span class="s3">!= </span><span class="s0">null</span><span class="s3">;</span>
        <span class="s1">ArrayList</span><span class="s3">&lt;</span><span class="s1">Player</span><span class="s3">&gt; </span><span class="s1">mutedPlayers </span><span class="s3">= </span><span class="s0">new </span><span class="s1">ArrayList</span><span class="s3">&lt;&gt;</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s0">try </span><span class="s5">{</span>
            <span class="s0">final </span><span class="s1">PreparedStatement query </span><span class="s3">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">prepareStatement</span><span class="s5">(</span><span class="s3">&quot;SELECT  FROM active_punishments WHERE punishment_type = 'MUTE';&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s0">final </span><span class="s1">ResultSet rs </span><span class="s3">= </span><span class="s1">query</span><span class="s2">.</span><span class="s1">executeQuery</span><span class="s5">()</span><span class="s3">;</span>
            <span class="s0">while </span><span class="s5">(</span><span class="s1">rs</span><span class="s2">.</span><span class="s1">next</span><span class="s5">()) { </span><span class="s4">// Get every player who is muted</span>
                <span class="s1">Player p </span><span class="s3">= </span><span class="s1">getPlayerFromUuid</span><span class="s5">(</span><span class="s1">UUID</span><span class="s2">.</span><span class="s1">fromString</span><span class="s5">(</span><span class="s1">rs</span><span class="s2">.</span><span class="s1">getString</span><span class="s5">(</span><span class="s3">&quot;player_id&quot;</span><span class="s5">)))</span><span class="s3">; </span><span class="s4">// Initialise variable for player</span>
                <span class="s0">if </span><span class="s5">(</span><span class="s1">p </span><span class="s3">== </span><span class="s0">null</span><span class="s5">) </span><span class="s4">// Check if player is online before adding to list</span>
                    <span class="s0">continue</span><span class="s3">;</span>
                <span class="s1">mutedPlayers</span><span class="s2">.</span><span class="s1">add</span><span class="s5">(</span><span class="s1">p</span><span class="s5">)</span><span class="s3">; </span><span class="s4">// Add player to list</span>
            <span class="s5">}</span>
        <span class="s5">} </span><span class="s0">catch </span><span class="s5">(</span><span class="s1">SQLException e</span><span class="s5">) {</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">severeError</span><span class="s5">(</span><span class="s3">&quot;A severe error has encountered while querying the database. The plugin has been shut down.&quot;</span><span class="s5">)</span><span class="s3">;</span>
            <span class="s1">DisciplineX</span><span class="s2">.</span><span class="s1">getInstance</span><span class="s5">()</span><span class="s2">.</span><span class="s1">shutdownPlugin</span><span class="s5">()</span><span class="s3">;</span>
        <span class="s5">}</span>
        <span class="s0">return </span><span class="s1">mutedPlayers</span><span class="s3">;</span>
    <span class="s5">}</span>

    <span class="s0">private </span><span class="s1">Player getPlayerFromUuid</span><span class="s5">(</span><span class="s0">final </span><span class="s1">@NotNull UUID uuid</span><span class="s5">) {</span>
        <span class="s0">return </span><span class="s1">Bukkit</span><span class="s2">.</span><span class="s1">getPlayer</span><span class="s5">(</span><span class="s1">uuid</span><span class="s5">)</span><span class="s3">;</span>
    <span class="s5">}</span>
<span class="s5">}</span>
</pre>
</body>
</html>